
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Example 6- Catchment analysis from the matrix transpose. &#8212; Quagmire.tex</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Linear diffusion - time evolution / benchmarking" href="Ex7-LinearDiffusion.html" />
    <link rel="prev" title="Example 5 - Preprocessing a surface" href="Ex5-PreprocessingSurfaces.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  
  <h1 class="site-logo" id="site-title">Quagmire.tex</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../FrontPage.html">
   Introduction to Quagmire
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Tutorial
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1-Creating-Meshes.html">
   Example 1 - creating structured and unstructured meshes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1-Creating-Meshes.html#structured-grids">
   Structured grids
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1-Creating-Meshes.html#unstructured-meshes">
   Unstructured meshes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1-Creating-Meshes.html#elliptical-mesh">
   Elliptical mesh
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1-Creating-Meshes.html#mesh-improvement">
   Mesh improvement
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1-Creating-Meshes.html#mesh-refinement">
   Mesh refinement
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1-Creating-Meshes.html#spherical-meshes">
   Spherical meshes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1-Creating-Meshes.html#save-mesh-to-file">
   Save mesh to file
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1a-QuagmireMeshVariables.html">
   quagmire.mesh MeshVariable
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1a-QuagmireMeshVariables.html#derivatives-gradients">
   Derivatives / gradients
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1a-QuagmireMeshVariables.html#higher-derivatives">
   Higher derivatives
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1a-QuagmireMeshVariables.html#saving-and-loading-mesh-variables">
   Saving and loading mesh variables
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1b-QuagmireLazyFunctions.html">
   Quagmire.function
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1b-QuagmireLazyFunctions.html#vector-functions">
   Vector functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1c-QuagmireCoordinateGeometry.html">
   Quagmire.function.geometry
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1c-QuagmireCoordinateGeometry.html#naked-coordinate-systems">
   Naked coordinate systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1c-QuagmireCoordinateGeometry.html#symbols">
   Symbols
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1c-QuagmireCoordinateGeometry.html#the-same-sort-of-thing-but-with-some-mesh-variables">
   The same sort of thing but with some mesh variables
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1d-QuagmireCloud.html">
   quagmire.tools.cloud
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1d-QuagmireCloud.html#my-cloud">
   My cloud ?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1d-QuagmireCloud.html#my-cloud-but-not-cloudstor">
   My cloud, but not cloudstor ?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1d-QuagmireCloud.html#i-want-to-share-a-file-for-others-to-access">
   I want to share a file for others to access
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex1d-QuagmireCloud.html#upload-download-tools">
   Upload / download tools
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex2-Topography-Meshes.html">
   Example 2 - Meshes for Topography
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex2-Topography-Meshes.html#height-field">
   Height field
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex2-Topography-Meshes.html#derivatives-and-slopes">
   Derivatives and slopes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex2-Topography-Meshes.html#smoothing">
   Smoothing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex3-Surface-Process-Meshes.html">
   Example 3 - Meshes for Surface Process Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex3-Surface-Process-Meshes.html#height-field-and-rainfall">
   Height field and Rainfall
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex3-Surface-Process-Meshes.html#upstream-area-and-stream-power">
   Upstream area and stream power
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex3-Surface-Process-Meshes.html#outflow-analysis">
   Outflow analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex4-Multiple-downhill-pathways.html">
   Example 4 - Matrix approaches - multiple paths
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex4-Multiple-downhill-pathways.html#build-a-test-mesh">
   Build a test mesh
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex4-Multiple-downhill-pathways.html#downhill-neighbours">
   1-2-3 downhill neighbours
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex4-Multiple-downhill-pathways.html#computational-efficiency">
   Computational Efficiency
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex4-Multiple-downhill-pathways.html#dense-downhill-matrices">
   Dense downhill matrices
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex5-PreprocessingSurfaces.html">
   Example 5 - Preprocessing a surface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex5-PreprocessingSurfaces.html#notebook-contents">
   Notebook contents
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Example 6- Catchment analysis from the matrix transpose.
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex7-LinearDiffusion.html">
   Linear diffusion - time evolution / benchmarking
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex7-LinearDiffusion.html#spatially-variable-diffusivity-circular-inclusion">
   Spatially variable diffusivity (circular “inclusion”)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex7a-NonLinearDiffusion.html">
   Non-Linear diffusion - a critical-slope diffusion implementation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex7a-NonLinearDiffusion.html#spatially-variable-diffusivity-circular-inclusion">
   Spatially variable diffusivity (circular “inclusion”)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex8-ErosionDeposition.html">
   Example 8 - Incision and Deposition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Ex9-LandscapeEvolution.html">
   Example 9 - Landscape Evolution
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Worked Examples (Building landscapes from data)
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx1-ETOPO1-workflow.html">
   Meshing ETOPO1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx1b-ETOPO1-highres-workflow.html">
   Meshing ETOPO1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx2-ETOPO1-Tasmania.html">
   Etopo1 Map of Tasmania
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx3-GADEM9H-Tasmania.html">
   Geoscience Australia 9s DEM Map of Tasmania
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx3-GADEM9H-Tasmania.html#retrieve-geoscience-australia-9s-dem-using-ga-wcs-service">
   Retrieve Geoscience Australia 9s DEM using GA WCS service
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx4-GADEM9H-Tasmania-Catchments.html">
   Geoscience Australia 9s DEM Map of Tasmania
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx4-GADEM9H-Tasmania-Catchments.html#apply-pit-filling-local-flooding-swamp-filling-algorithm">
   Apply pit filling / local-flooding / swamp filling algorithm
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx4p-GADEM9H-Tasmania-Catchments.html">
   Geoscience Australia 9s DEM Map of Tasmania
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx4p-GADEM9H-Tasmania-Catchments.html#apply-pit-filling-local-flooding-swamp-filling-algorithm">
   Apply pit filling / local-flooding / swamp filling algorithm
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx4s-GADEM9H-Tasmania-Catchments.html">
   Geoscience Australia 9s DEM Map of Tasmania
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx4s-GADEM9H-Tasmania-Catchments.html#apply-pit-filling-local-flooding-swamp-filling-algorithm">
   Apply pit filling / local-flooding / swamp filling algorithm
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx5-GlobalModels.html">
   Models on the Sphere
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx6-Preliminary-crop.html">
   Spherical mesh of Australia
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx6-spherical-mesh-of-Australia.html">
   Spherical mesh of Australia
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx6-UsingStoredMeshes.html">
   Models from the cloud
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx7-Diffusion.html">
   Diffusion
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../WorkedExamples/WEx7-Diffusion.html#let-s-try-letting-this-height-diffuse-with-time">
   Let’s try letting this height diffuse with time
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/Tutorial/Ex6-Catchment-Analysis.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/Tutorial/Ex6-Catchment-Analysis.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/underworldcode/quagmire"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/underworldcode/quagmire/dev?urlpath=tree/jupyterbook/Tutorial/Ex6-Catchment-Analysis.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#notebook-contents">
   Notebook contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#construct-the-swamp-mountain-mesh">
   Construct the swamp-mountain mesh
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#process-the-surface-to-fill-swamps-and-lakes">
   Process the surface to fill swamps and lakes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#locating-and-viewing-the-outflow-points">
   Locating and viewing the outflow points
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-neighbours-to-1-and-compute-uphill-connectivity">
   Set neighbours to 1 and compute “uphill” connectivity
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualise-the-catchment-information">
   Visualise the catchment information
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="example-6-catchment-analysis-from-the-matrix-transpose">
<h1>Example 6- Catchment analysis from the matrix transpose.<a class="headerlink" href="#example-6-catchment-analysis-from-the-matrix-transpose" title="Permalink to this headline">¶</a></h1>
<p>We start with “Swamp Mountain” from the previous notebooks. This is slightly modified so that there are no lakes / pits right at the boundary.</p>
<p>The catchments are identified by first finding all the outflow points of the mesh (local minima that correspond to the boundary mask) and then using the transpose of the downhill-propagation matrix <span class="math notranslate nohighlight">\(D^T\)</span> to run information (the unique ID of each outflow points) up to the top of the catchment.</p>
<p>The stopping condition is that no further change occurs.</p>
<p><em>Note</em> in the context of multiple pathways, this operation produces a fuzzy catchment. The first thing we do in this notebook is to specify <code class="docutils literal notranslate"><span class="pre">downhill_neighbours=1</span></code></p>
<div class="section" id="notebook-contents">
<h2>Notebook contents<a class="headerlink" href="#notebook-contents" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="#1-2-3-downhill-neighbours">1-2-3 downhill neighbours</a></p></li>
<li><p><a class="reference external" href="#Set-neighbours-to-1-and-compute-%22uphill%22-connectivity">Upstream propogation</a></p></li>
<li><p><a class="reference external" href="#Dense-downhill-matrices">Dense downhill matrices</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">quagmire</span> <span class="kn">import</span> <span class="n">tools</span> <span class="k">as</span> <span class="n">meshtools</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="construct-the-swamp-mountain-mesh">
<h2>Construct the swamp-mountain mesh<a class="headerlink" href="#construct-the-swamp-mountain-mesh" title="Permalink to this headline">¶</a></h2>
<p>This time we take care to avoid lakes etc on the boundaries as this makes the catchment analysis more complicated. Visualise the mesh to make sure that this works.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">quagmire</span> <span class="kn">import</span> <span class="n">QuagMesh</span> 
<span class="kn">from</span> <span class="nn">quagmire</span> <span class="kn">import</span> <span class="n">QuagMesh</span> <span class="c1"># all routines we need are within this class</span>
<span class="kn">from</span> <span class="nn">quagmire</span> <span class="kn">import</span> <span class="n">QuagMesh</span>

<span class="n">minX</span><span class="p">,</span> <span class="n">maxX</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span>
<span class="n">minY</span><span class="p">,</span> <span class="n">maxY</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span>

<span class="n">spacingX</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">spacingY</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">simplices</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">elliptical_mesh</span><span class="p">(</span><span class="n">minX</span><span class="p">,</span> <span class="n">maxX</span><span class="p">,</span> <span class="n">minY</span><span class="p">,</span> <span class="n">maxY</span><span class="p">,</span> <span class="n">spacingX</span><span class="p">,</span> <span class="n">spacingY</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>

<span class="n">DM</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">create_DMPlex</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">simplices</span><span class="p">)</span>
<span class="n">DM</span> <span class="o">=</span> <span class="n">meshtools</span><span class="o">.</span><span class="n">refine_DM</span><span class="p">(</span><span class="n">DM</span><span class="p">,</span> <span class="n">refinement_levels</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">mesh</span> <span class="o">=</span> <span class="n">QuagMesh</span><span class="p">(</span><span class="n">DM</span><span class="p">,</span> <span class="n">downhill_neighbours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Note ... this is what refinement does </span>
<span class="n">x</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Number of points in the triangulation: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">npoints</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Underlying Mesh type: TriMesh
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Delaunay triangulation 0.5668627370000081s
0 - Calculate node weights and area 0.018873675000008916s
0 - Find boundaries 0.004186916999969981s
0 - cKDTree 0.03901435400001674s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Construct neighbour cloud arrays 1.0646847959999945s, (0.569300945000009s + 0.4953407509999579s)
0 - Construct rbf weights 0.10116069800000105s

Number of points in the triangulation: 156925
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">radius</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="n">theta</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="mf">0.1</span>

<span class="n">height</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.025</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.2</span><span class="o">*</span><span class="n">radius</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span>  <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">5.0</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="c1">## Less so</span>
<span class="n">height</span>  <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">0.2</span><span class="o">*</span><span class="n">radius</span><span class="p">)</span>
<span class="n">height</span>  <span class="o">-=</span> <span class="n">height</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="c1">## Add smoothed random noise to make some &quot;lakes&quot; </span>

<span class="n">mesh</span><span class="o">.</span><span class="n">_construct_rbf_weights</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">delta</span><span class="o">*</span><span class="mf">3.0</span><span class="p">)</span>

<span class="n">randpts1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">height</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.995</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="n">hrand1</span>   <span class="o">=</span> <span class="mf">20.0</span> <span class="o">*</span> <span class="n">mesh</span><span class="o">.</span><span class="n">rbf_smoother</span><span class="p">(</span><span class="n">randpts1</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">heightn</span> <span class="o">=</span> <span class="n">height</span> <span class="o">+</span> <span class="n">hrand1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mf">15.0</span><span class="p">)</span> 


<span class="k">with</span> <span class="n">mesh</span><span class="o">.</span><span class="n">deform_topography</span><span class="p">():</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">downhill_neighbours</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">topography</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">heightn</span>


<span class="c1"># let&#39;s use a rainfall proportional to height (any choice is ok)</span>

<span class="n">rainfall_fn</span>  <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topography</span> <span class="o">**</span> <span class="mf">2.0</span>
<span class="n">flowrate_fn</span>  <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">upstream_integral_fn</span><span class="p">(</span><span class="n">rainfall_fn</span><span class="p">)</span>
<span class="n">str_power_fn</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">upstream_integral_fn</span><span class="p">(</span><span class="n">rainfall_fn</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mesh</span><span class="o">.</span><span class="n">slope</span> <span class="o">**</span> <span class="mf">2.0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.22553968799996937s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.32239416800001663s
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="process-the-surface-to-fill-swamps-and-lakes">
<h2>Process the surface to fill swamps and lakes<a class="headerlink" href="#process-the-surface-to-fill-swamps-and-lakes" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Quagmire also has a swamp filling algorithm</span>

<span class="n">mesh1s</span> <span class="o">=</span> <span class="n">QuagMesh</span><span class="p">(</span><span class="n">DM</span><span class="p">)</span>
<span class="k">with</span> <span class="n">mesh1s</span><span class="o">.</span><span class="n">deform_topography</span><span class="p">():</span>
    <span class="n">mesh1s</span><span class="o">.</span><span class="n">topography</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topography</span><span class="o">.</span><span class="n">data</span>
    
<span class="n">mesh1s</span><span class="o">.</span><span class="n">low_points_local_patch_fill</span><span class="p">(</span><span class="n">its</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">smoothing_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">mesh1s</span><span class="o">.</span><span class="n">low_points_swamp_fill</span><span class="p">(</span><span class="n">ref_height</span><span class="o">=-</span><span class="mf">0.01</span><span class="p">)</span>
    
    <span class="c1"># In parallel, we can&#39;t break if ANY processor has work to do (barrier / sync issue)</span>
    <span class="n">low_points2</span> <span class="o">=</span> <span class="n">mesh1s</span><span class="o">.</span><span class="n">identify_global_low_points</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">low_points2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">low_points2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Underlying Mesh type: TriMesh
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Delaunay triangulation 0.5252722660000018s
0 - Calculate node weights and area 0.015205560000026708s
0 - Find boundaries 0.0032109130000321784s
0 - cKDTree 0.03645324299998265s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Construct neighbour cloud arrays 1.040844691000018s, (0.555766985000048s + 0.48503370600002427s)
0 - Construct rbf weights 0.08119591899998113s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20328319800000827s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.32206016499998213s
Low point local patch fill
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20289379700000154s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20395739999997886s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20324979699995538s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.203577499000005s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.2027722949999884s
Low point local patch fill  1.2112965520000216  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.321986862000017s
110  iterations, time =  0.14457416599998396
Build low point catchments -  0.14541236899998466  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0  Sort spills -  0.011980946999983644
0  Gather spill data -  0.0001548000000184402
0  Sort all spills -  0.00012770000000728032
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.21090302599998267s
Low point swamp fill  0.5276396670000167  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.5160112209999852s
0 : 55
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>231  iterations, time =  0.293488348999972
Build low point catchments -  0.29439045300000544  seconds
0  Sort spills -  0.006255223999971804
0  Gather spill data -  0.00010320100000171806
0  Sort all spills -  7.060000001501976e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.2104328230000192s
Low point swamp fill  0.6012582530000259  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.5939649229999873s
1 : 16
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>262  iterations, time =  0.32224736000000576
Build low point catchments -  0.3231601640000008  seconds
0  Sort spills -  0.0033637129999988247
0  Gather spill data -  0.00010830099995473574
0  Sort all spills -  6.0700000005908805e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.21121742499997254s
Low point swamp fill  0.6042435619999651  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.5947629230000189s
2 : 8
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>275  iterations, time =  0.33655441500002325
Build low point catchments -  0.3374288180000349  seconds
0  Sort spills -  0.002775510999981634
0  Gather spill data -  0.00010799999995469989
0  Sort all spills -  6.060100002969193e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20412059699998508s
Low point swamp fill  0.5998043420000272  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6494532340000205s
3 : 7
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.3950235410000005
Build low point catchments -  0.3959723440000289  seconds
0  Sort spills -  0.0025132090000283824
0  Gather spill data -  0.00010880100001031678
0  Sort all spills -  6.100000001652006e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20508329899996625s
Low point swamp fill  0.6574117639999599  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6496581320000132s
4 : 4
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.3922386280000296
Build low point catchments -  0.3931627310000181  seconds
0  Sort spills -  0.0012659049999683702
0  Gather spill data -  0.00011650099997950747
0  Sort all spills -  0.0005195019999746364
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20350779299997157s
Low point swamp fill  0.6432701049999991  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6547516489999907s
5 : 3
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.3933926310000402
Build low point catchments -  0.39426423399999067  seconds
0  Sort spills -  0.0006362019999528457
0  Gather spill data -  0.0003867010000249138
0  Sort all spills -  0.000282102000028317
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20304149000003235s
Low point swamp fill  0.640586092000035  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6529885390000345s
6 : 2
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.39458743400001595
Build low point catchments -  0.39558603799997627  seconds
0  Sort spills -  0.0006419029999733539
0  Gather spill data -  0.00010229999998045969
0  Sort all spills -  5.8899999999084685e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20267458699998997s
Low point swamp fill  0.6419814939999924  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6503367810000213s
7 : 3
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.40155720299998166
Build low point catchments -  0.40251381799998853  seconds
0  Sort spills -  0.0006533099999614933
0  Gather spill data -  0.00010580200000731566
0  Sort all spills -  5.4100999989259435e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20374494800000775s
Low point swamp fill  0.6503332449999562  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6487000950000379s
8 : 3
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.39923223400001007
Build low point catchments -  0.4001688490000106  seconds
0  Sort spills -  0.0006533100000183367
0  Gather spill data -  0.00010350100001232931
0  Sort all spills -  5.700100001604369e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.2036921290000464s
Low point swamp fill  0.6466191349999804  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6514644599999997s
9 : 3
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.39381231800001615
Build low point catchments -  0.39480843299998014  seconds
0  Sort spills -  0.000662909999959993
0  Gather spill data -  0.0001023010000267277
0  Sort all spills -  5.660099998294754e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20376609800001688s
Low point swamp fill  0.6413819819999844  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6555858670000134s
10 : 3
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.39315445299996554
Build low point catchments -  0.3940704670000059  seconds
0  Sort spills -  0.0006522099999983766
0  Gather spill data -  0.00041400600002816645
0  Sort all spills -  0.00028810399999201763
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20286486800000603s
Low point swamp fill  0.639538578999975  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6507738250000443s
11 : 2
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.39186249499999803
Build low point catchments -  0.3925700060000281  seconds
0  Sort spills -  0.0006251089999977921
0  Gather spill data -  0.0003921060000493526
0  Sort all spills -  7.720199999994293e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20322345699997868s
Low point swamp fill  0.6381026999999904  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6480185099999858s
12 : 3
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.39818095900000117
Build low point catchments -  0.3991069730000163  seconds
0  Sort spills -  0.0006315090000157397
0  Gather spill data -  0.00010740100003658881
0  Sort all spills -  5.4900000009183714e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20357883500003027s
Low point swamp fill  0.645464349000008  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6506002859999853s
13 : 3
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.39386124899999686
Build low point catchments -  0.3947984630000292  seconds
0  Sort spills -  0.0006572089999963282
0  Gather spill data -  0.00010740199996916999
0  Sort all spills -  5.400100002361796e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20215119400000958s
Low point swamp fill  0.6398408910000057  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6501195220000113s
14 : 2
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.3971088499999951
Build low point catchments -  0.39801856399998314  seconds
0  Sort spills -  0.0006383090000099401
0  Gather spill data -  0.00037990599997783647
0  Sort all spills -  0.00028620400001955204
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.2036089000000061s
Low point swamp fill  0.644541495999988  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6500199469999757s
15 : 4
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.3978422310000269
Build low point catchments -  0.398780644999988  seconds
0  Sort spills -  0.0006466099999897779
0  Gather spill data -  0.00036020499999267486
0  Sort all spills -  0.00029350400001249
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20306387300001916s
Low point swamp fill  0.6444415429999708  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6499467770000251s
16 : 3
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.3917323059999944
Build low point catchments -  0.39270512000001645  seconds
0  Sort spills -  0.0006570099999976264
0  Gather spill data -  0.0001068020000047909
0  Sort all spills -  5.350100002488034e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.2028986430000259s
Low point swamp fill  0.6393995980000113  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6516495520000376s
17 : 2
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.3942793919999872
Build low point catchments -  0.3952199050000331  seconds
0  Sort spills -  0.0006297090000089156
0  Gather spill data -  0.00010570099999540616
0  Sort all spills -  6.040099998472215e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20290342800001326s
Low point swamp fill  0.6407083480000324  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6494932530000028s
18 : 2
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.39247363499998755
Build low point catchments -  0.39337244800003646  seconds
0  Sort spills -  0.0006239089999553471
0  Gather spill data -  0.00010440099998731966
0  Sort all spills -  5.5501000019830826e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20287071300003845s
Low point swamp fill  0.6389539740000032  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6567485870000382s
19 : 2
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.39198119899998574
Build low point catchments -  0.39285791200001086  seconds
0  Sort spills -  0.000645108999947297
0  Gather spill data -  0.00010450100000980456
0  Sort all spills -  5.730100002665495e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20392359800001714s
Low point swamp fill  0.6391393139999764  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6505870459999983s
20 : 2
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.3962214109999991
Build low point catchments -  0.3971490250000329  seconds
0  Sort spills -  0.000622609000004104
0  Gather spill data -  0.00010330100002420295
0  Sort all spills -  5.780100002539257e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20290166899997075s
Low point swamp fill  0.6428774990000079  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.653010122000012s
21 : 2
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.39207001599999103
Build low point catchments -  0.3929671280000093  seconds
0  Sort spills -  0.0006368090000137272
0  Gather spill data -  0.00010080099997367142
0  Sort all spills -  5.5400999997345934e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.20235894699999335s
Low point swamp fill  0.638034575000006  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6582773270000075s
22 : 2
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>320  iterations, time =  0.3913974779999876
Build low point catchments -  0.39232009099998777  seconds
0  Sort spills -  0.000628509000023314
0  Gather spill data -  0.00010470099999793092
0  Sort all spills -  5.930100002160543e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build downhill matrices 0.2027743300000111s
Low point swamp fill  0.6378907209999625  seconds
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 - Build upstream areas 0.6493166430000201s
23 : 2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rainfall_fn_1s</span>  <span class="o">=</span> <span class="n">mesh1s</span><span class="o">.</span><span class="n">topography</span> <span class="o">**</span> <span class="mf">2.0</span>
<span class="n">flowrate_fn_1s</span>  <span class="o">=</span> <span class="n">mesh1s</span><span class="o">.</span><span class="n">upstream_integral_fn</span><span class="p">(</span><span class="n">rainfall_fn_1s</span><span class="p">)</span>
<span class="n">str_power_fn_1s</span> <span class="o">=</span> <span class="n">mesh1s</span><span class="o">.</span><span class="n">upstream_integral_fn</span><span class="p">(</span><span class="n">rainfall_fn_1s</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mesh</span><span class="o">.</span><span class="n">slope</span> <span class="o">**</span> <span class="mf">2.0</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="locating-and-viewing-the-outflow-points">
<h2>Locating and viewing the outflow points<a class="headerlink" href="#locating-and-viewing-the-outflow-points" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">quagmire</span></code> provides a mechanism to find the outflow points of a domain and return the node values. <em>Note:</em> in parallel these are the local node numbers and are not a unique ID. To do this, we can obtain the global ID from PETSc but it does also help to have the indices all be small numbers so we can map colours effectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">outflows</span> <span class="o">=</span> <span class="n">mesh1s</span><span class="o">.</span><span class="n">identify_outflow_points</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mesh has </span><span class="si">{}</span><span class="s2"> outflows&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outflows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">quagmire</span>
<span class="nb">print</span><span class="p">(</span><span class="n">quagmire</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">check_object_is_a_q_mesh_and_raise</span><span class="p">(</span><span class="n">mesh1s</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">lavavu</span>

<span class="n">outpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">mesh</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">outflows</span><span class="p">],</span> <span class="n">heightn</span><span class="p">[</span><span class="n">outflows</span><span class="p">]])</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">mesh</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">heightn</span><span class="p">])</span>

<span class="n">lv</span> <span class="o">=</span> <span class="n">lavavu</span><span class="o">.</span><span class="n">Viewer</span><span class="p">(</span><span class="n">border</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="s2">&quot;#FFFFFF&quot;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="p">[</span><span class="mi">600</span><span class="p">,</span><span class="mi">600</span><span class="p">],</span> <span class="n">near</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">)</span>

<span class="n">nodes</span> <span class="o">=</span> <span class="n">lv</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="s2">&quot;nodes&quot;</span><span class="p">,</span> <span class="n">pointsize</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">pointtype</span><span class="o">=</span><span class="s2">&quot;shiny&quot;</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;#FF0000&quot;</span> <span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">vertices</span><span class="p">(</span><span class="n">outpoints</span><span class="p">)</span>

<span class="n">tri1</span> <span class="o">=</span> <span class="n">lv</span><span class="o">.</span><span class="n">triangles</span><span class="p">(</span><span class="s2">&quot;triangles&quot;</span><span class="p">,</span> <span class="n">wireframe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">tri1</span><span class="o">.</span><span class="n">vertices</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
<span class="n">tri1</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">simplices</span><span class="p">)</span>

<span class="n">tri1</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">flowrate_fn_1s</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">mesh1s</span><span class="p">)),</span> <span class="s2">&quot;cum-rain-swamp&quot;</span><span class="p">)</span>
<span class="n">tri1</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">flowrate_fn</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">mesh</span><span class="p">)),</span>     <span class="s2">&quot;cumulative rain&quot;</span><span class="p">)</span>

<span class="n">tri1</span><span class="o">.</span><span class="n">colourmap</span><span class="p">(</span><span class="s2">&quot;#BBEEBB #889988 #000099&quot;</span><span class="p">)</span>
<span class="n">tri1</span><span class="o">.</span><span class="n">colourbar</span><span class="p">()</span>

<span class="c1">## Swamped</span>

<span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">mesh1s</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">mesh1s</span><span class="o">.</span><span class="n">topography</span><span class="o">.</span><span class="n">data</span><span class="o">-</span><span class="mf">0.01</span><span class="p">])</span>

<span class="n">tri2</span> <span class="o">=</span> <span class="n">lv</span><span class="o">.</span><span class="n">triangles</span><span class="p">(</span><span class="s2">&quot;triangles2&quot;</span><span class="p">,</span> <span class="n">wireframe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">tri2</span><span class="o">.</span><span class="n">vertices</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
<span class="n">tri2</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">mesh1s</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">simplices</span><span class="p">)</span>

<span class="n">tri2</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">mesh1s</span><span class="o">.</span><span class="n">topography</span><span class="o">.</span><span class="n">data</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">topography</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>   <span class="s2">&quot;swamps&quot;</span><span class="p">)</span>
<span class="n">tri2</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mesh1s</span><span class="o">.</span><span class="n">topography</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="s2">&quot;blank&quot;</span><span class="p">)</span>
<span class="n">tri2</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">flowrate_fn_1s</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">mesh1s</span><span class="p">)),</span> <span class="s2">&quot;cum-rain-swamp&quot;</span><span class="p">)</span>

<span class="n">tri2</span><span class="o">.</span><span class="n">colourmap</span><span class="p">(</span><span class="s2">&quot;#003366:0.5, #000099:0.8, #000099&quot;</span><span class="p">)</span>
<span class="n">tri2</span><span class="o">.</span><span class="n">colourbar</span><span class="p">()</span>


<span class="n">lv</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">Panel</span><span class="p">()</span>
<span class="n">lv</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">ObjectList</span><span class="p">()</span>
<span class="n">tri1</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cum-rain-swamp&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;cumulative rain&quot;</span><span class="p">,</span> 
                   <span class="p">],</span> <span class="nb">property</span><span class="o">=</span><span class="s2">&quot;colourby&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s2">&quot;redraw&quot;</span><span class="p">)</span>

<span class="n">tri2</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">,</span> <span class="s2">&quot;swamps&quot;</span><span class="p">,</span> 
                   <span class="s2">&quot;cum-rain-swamp&quot;</span><span class="p">],</span> <span class="nb">property</span><span class="o">=</span><span class="s2">&quot;colourby&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s2">&quot;redraw&quot;</span><span class="p">)</span>


<span class="n">lv</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Stream power / slope where the lakes / swamps are located:</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="set-neighbours-to-1-and-compute-uphill-connectivity">
<h2>Set neighbours to 1 and compute “uphill” connectivity<a class="headerlink" href="#set-neighbours-to-1-and-compute-uphill-connectivity" title="Permalink to this headline">¶</a></h2>
<p>In serial, i.e. for this demonstration, we number the outflow points by their order in the local mesh numbering. We can then use the <code class="docutils literal notranslate"><span class="pre">mesh.uphill_propagation</span></code> routine to propagate this information from the outflow to the top of the catchment.</p>
<p>This routine returns the mesh data (for this processor) of a globally synchronised map of the information propagated from the selected points.</p>
<p>The routine is used in the computation of flood fills for the swamp algorithm and should be polished up a bit (sorry).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Unique catchments requires the downhill matrix with downhill_neighbours=1</span>

<span class="n">mesh1s</span><span class="o">.</span><span class="n">near_neighbours</span><span class="o">=</span><span class="mi">1</span>
<span class="c1"># mesh1s.update_height(mesh1s.heightVariable.data)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Need a unique ID that works in parallel ... global node number would work but </span>
<span class="c1">## not that easy to map to colours in lavavu </span>

<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="n">outflows</span>
<span class="n">outflowID</span> <span class="o">=</span> <span class="n">mesh1s</span><span class="o">.</span><span class="n">lgmap_row</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">outflows</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">PETSc</span><span class="o">.</span><span class="n">IntType</span><span class="p">))</span>

<span class="c1"># But on 1 proc, this is easier / better:</span>

<span class="n">outflowID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">outflows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">ctmt</span> <span class="o">=</span> <span class="n">mesh1s</span><span class="o">.</span><span class="n">uphill_propagation</span><span class="p">(</span><span class="n">outflows</span><span class="p">,</span>  <span class="n">outflowID</span><span class="p">,</span> <span class="n">its</span><span class="o">=</span><span class="mi">99999</span><span class="p">,</span> <span class="n">fill</span><span class="o">=-</span><span class="mi">999999</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="visualise-the-catchment-information">
<h2>Visualise the catchment information<a class="headerlink" href="#visualise-the-catchment-information" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">lavavu</span>

<span class="n">outpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">mesh</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">outflows</span><span class="p">],</span> <span class="n">heightn</span><span class="p">[</span><span class="n">outflows</span><span class="p">]])</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">mesh</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">mesh1s</span><span class="o">.</span><span class="n">topography</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>

<span class="n">lv</span> <span class="o">=</span> <span class="n">lavavu</span><span class="o">.</span><span class="n">Viewer</span><span class="p">(</span><span class="n">border</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="s2">&quot;#FFFFFF&quot;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="p">[</span><span class="mi">900</span><span class="p">,</span><span class="mi">600</span><span class="p">],</span> <span class="n">near</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">)</span>

<span class="n">nodes</span> <span class="o">=</span> <span class="n">lv</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="s2">&quot;nodes&quot;</span><span class="p">,</span> <span class="n">pointsize</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">pointtype</span><span class="o">=</span><span class="s2">&quot;shiny&quot;</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;#FF0000&quot;</span> <span class="p">)</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">vertices</span><span class="p">(</span><span class="n">outpoints</span><span class="p">)</span>

<span class="n">tri1</span> <span class="o">=</span> <span class="n">lv</span><span class="o">.</span><span class="n">triangles</span><span class="p">(</span><span class="s2">&quot;triangles&quot;</span><span class="p">,</span> <span class="n">wireframe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">tri1</span><span class="o">.</span><span class="n">vertices</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
<span class="n">tri1</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">simplices</span><span class="p">)</span>
<span class="n">tri1</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">flowrate_fn_1s</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">mesh1s</span><span class="p">)),</span><span class="s2">&quot;cum-rain-swamp&quot;</span><span class="p">)</span>

<span class="n">tri1</span><span class="o">.</span><span class="n">colourmap</span><span class="p">(</span><span class="s2">&quot;#BBEEBB:0.0, #889988:0.2, #889988:0.2, #0000FF:0.2, #0000FF&quot;</span><span class="p">)</span>
<span class="n">tri1</span><span class="o">.</span><span class="n">colourbar</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1">## Swamped</span>

<span class="n">tri2</span> <span class="o">=</span> <span class="n">lv</span><span class="o">.</span><span class="n">triangles</span><span class="p">(</span><span class="s2">&quot;triangles2&quot;</span><span class="p">,</span> <span class="n">wireframe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">tri2</span><span class="o">.</span><span class="n">vertices</span><span class="p">(</span><span class="n">points</span><span class="o">-</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.01</span><span class="p">))</span>
<span class="n">tri2</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">mesh1s</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">simplices</span><span class="p">)</span>

<span class="n">tri2</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">ctmt</span><span class="p">,</span>   <span class="s2">&quot;catchments&quot;</span><span class="p">)</span>

<span class="n">tri2</span><span class="o">.</span><span class="n">colourmap</span><span class="p">(</span><span class="s2">&quot;spectral&quot;</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">outflows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">tri2</span><span class="o">.</span><span class="n">colourbar</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">tri3</span> <span class="o">=</span> <span class="n">lv</span><span class="o">.</span><span class="n">triangles</span><span class="p">(</span><span class="s2">&quot;triangles3&quot;</span><span class="p">,</span> <span class="n">wireframe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">tri3</span><span class="o">.</span><span class="n">vertices</span><span class="p">(</span><span class="n">points</span><span class="o">-</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.005</span><span class="p">))</span>

<span class="n">tri3</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">mesh1s</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">simplices</span><span class="p">)</span>
<span class="n">tri3</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">mesh1s</span><span class="o">.</span><span class="n">topography</span><span class="o">.</span><span class="n">data</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">topography</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>   <span class="s2">&quot;swamps&quot;</span><span class="p">)</span>
<span class="n">tri3</span><span class="o">.</span><span class="n">colourmap</span><span class="p">(</span><span class="s2">&quot;#003366:0.0, #000099,  #000099, #000099, #0000FF&quot;</span><span class="p">)</span>
<span class="n">tri3</span><span class="o">.</span><span class="n">colourbar</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="n">lv</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">Panel</span><span class="p">()</span>
<span class="n">lv</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">ObjectList</span><span class="p">()</span>

<span class="n">lv</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Tutorial"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="Ex5-PreprocessingSurfaces.html" title="previous page">Example 5 - Preprocessing a surface</a>
    <a class='right-next' id="next-link" href="Ex7-LinearDiffusion.html" title="next page">Linear diffusion - time evolution / benchmarking</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Louis Moresi, Ben Mather, Romain Beucher<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>